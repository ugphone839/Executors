<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executor Admin Panel</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg: #121212;
            --surface: #1e1e1e;
            --primary: #bb86fc;
            --secondary: #03dac6;
            --text: #e0e0e0;
            --danger: #cf6679;
            --success: #4caf50;
        }

        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); overflow-x: hidden; }
        
        /* LOGIN SCREEN */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .login-box { background: var(--surface); padding: 30px; border-radius: 10px; text-align: center; width: 300px; }
        .login-box input { width: 90%; padding: 10px; margin: 10px 0; background: #333; border: 1px solid #555; color: white; border-radius: 5px; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: black; }
        .btn-success { background: var(--success); color: white; }
        
        /* MAIN LAYOUT */
        #app { display: none; height: 100vh; display: flex; flex-direction: column; }
        
        /* HEADER */
        .header {
            background: var(--surface); padding: 15px; display: flex; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5); position: sticky; top: 0; z-index: 100;
        }
        .menu-btn { font-size: 24px; cursor: pointer; margin-right: 20px; color: var(--text); }
        .title { font-size: 20px; font-weight: bold; }

        /* SIDEBAR */
        .sidebar {
            position: fixed; left: -250px; top: 60px; bottom: 0; width: 250px;
            background: #181818; transition: 0.3s; z-index: 99; padding-top: 20px;
            border-right: 1px solid #333;
        }
        .sidebar.active { left: 0; }
        .nav-item {
            padding: 15px 20px; cursor: pointer; border-left: 3px solid transparent; transition: 0.2s;
        }
        .nav-item:hover, .nav-item.active { background: #2a2a2a; border-left-color: var(--primary); }
        .nav-item i { margin-right: 10px; width: 20px; text-align: center; }

        /* CONTENT */
        .main-content { padding: 20px; flex: 1; overflow-y: auto; margin-left: 0; transition: 0.3s; }
        .sidebar.active ~ .main-content { margin-left: 250px; } /* Desktop push */

        /* EXECUTOR CARDS */
        .executor-card {
            background: var(--surface); border-radius: 10px; padding: 20px; margin-bottom: 20px;
            border: 1px solid #333; position: relative;
        }
        .card-header { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: var(--secondary); display: flex; justify-content: space-between; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 14px; color: #aaa; }
        .form-control {
            width: 100%; padding: 10px; background: #2c2c2c; border: 1px solid #444;
            color: white; border-radius: 5px; box-sizing: border-box;
        }
        .form-control:focus { outline: none; border-color: var(--primary); }

        /* SAVE BUTTON (FLOATING) */
        .fab-save {
            position: fixed; bottom: 30px; right: 30px;
            background: var(--success); color: white;
            width: 60px; height: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            cursor: pointer; transition: 0.3s; z-index: 200;
        }
        .fab-save:hover { transform: scale(1.1); }
        .fab-save.loading { background: #555; cursor: not-allowed; }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .sidebar.active ~ .main-content { margin-left: 0; opacity: 0.3; pointer-events: none; }
        }
    </style>
</head>
<body>

    <!-- 1. LOGIN SCREEN -->
    <div id="login-overlay">
        <div class="login-box">
            <h2>üîê Admin Access</h2>
            <input type="password" id="password-input" placeholder="Nh·∫≠p m·∫≠t kh·∫©u...">
            <button class="btn btn-primary" onclick="attemptLogin()">ƒêƒÉng nh·∫≠p</button>
            <p id="login-msg" style="color: red; margin-top: 10px;"></p>
        </div>
    </div>

    <!-- 2. MAIN APP -->
    <div id="app" style="display: none;">
        <!-- Header -->
        <div class="header">
            <i class="fas fa-bars menu-btn" onclick="toggleSidebar()"></i>
            <div class="title">Executors Manager</div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="nav-item active" onclick="switchTab('pc')">
                <i class="fas fa-desktop"></i> PC Executors
            </div>
            <div class="nav-item" onclick="switchTab('android')">
                <i class="fab fa-android"></i> Android Executors
            </div>
            <div class="nav-item" onclick="switchTab('ios')">
                <i class="fab fa-apple"></i> iOS Executors
            </div>
        </div>

        <!-- Content -->
        <div class="main-content" id="content-area">
            <h2>ƒêang t·∫£i d·ªØ li·ªáu...</h2>
        </div>

        <!-- Save Button -->
        <div class="fab-save" onclick="saveToGithub()" title="Ho√†n th√†nh & L∆∞u">
            <i class="fas fa-save"></i>
        </div>
    </div>

    <script>
        let DATA = null;
        let PASSWORD = "";
        let CURRENT_TAB = 'pc';

        // --- AUTHENTICATION ---
        function attemptLogin() {
            const pass = document.getElementById('password-input').value;
            if(!pass) return;
            PASSWORD = pass;
            // Gi·∫£ l·∫≠p login th√†nh c√¥ng ƒë·ªÉ load data (Check pass th·∫≠t ·ªü server khi save)
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            loadData();
        }

        // --- DATA HANDLING ---
        async function loadData() {
            try {
                // T·∫£i RAW t·ª´ GitHub (Tr√°nh cache)
                const res = await fetch('https://raw.githubusercontent.com/ugphone839/Executors/refs/heads/main/script.js?t=' + Date.now());
                if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i file script.js");
                const text = await res.text();
                
                // Parse JS Object t·ª´ string
                const match = text.match(/const EXECUTOR_DATA = ({[\s\S]*?});/);
                if (match) {
                    // D√πng eval m·ªôt c√°ch c·∫©n th·∫≠n ƒë·ªÉ parse object
                    // V√¨ ƒë√¢y l√† tool admin n·ªôi b·ªô n√™n eval ch·∫•p nh·∫≠n ƒë∆∞·ª£c
                    DATA = eval('(' + match[1] + ')');
                    renderTab(CURRENT_TAB);
                } else {
                    alert("L·ªói: Kh√¥ng t√¨m th·∫•y bi·∫øn EXECUTOR_DATA");
                }
            } catch (e) {
                alert("L·ªói t·∫£i d·ªØ li·ªáu: " + e.message);
            }
        }

        // --- UI RENDERING ---
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        function switchTab(platform) {
            CURRENT_TAB = platform;
            // Update active class sidebar
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // Mobile: Close sidebar after select
            if(window.innerWidth < 768) toggleSidebar();
            
            renderTab(platform);
        }

        function renderTab(platform) {
            const container = document.getElementById('content-area');
            container.innerHTML = `<h2>üì± Ch·ªânh s·ª≠a: ${platform.toUpperCase()}</h2>`;

            if (!DATA || !DATA[platform]) {
                container.innerHTML += "<p>Kh√¥ng c√≥ d·ªØ li·ªáu.</p>";
                return;
            }

            DATA[platform].forEach((exe, index) => {
                const isDual = exe.links.length > 1;
                
                // T·∫°o Options cho Status
                let statusOptions = '';
                if (isDual) {
                    // 4 Options cho Dual Link
                    const opts = [
                        {val: 'Online', label: 'üü¢ C·∫£ 2 Online'},
                        {val: 'Offline', label: 'üî¥ C·∫£ 2 Offline'},
                        {val: 'Partial_GOn', label: 'üü° Global On / VNG Off'},
                        {val: 'Partial_VOn', label: 'üü° Global Off / VNG On'}
                    ];
                    // Logic map status hi·ªán t·∫°i sang dropdown
                    // C√°i n√†y h∆°i ph·ª©c t·∫°p v√¨ bot l∆∞u text. Ta check exe.status v√† link statusText
                    // ƒê·ªÉ ƒë∆°n gi·∫£n, ta map theo exe.status ch√≠nh
                    opts.forEach(o => {
                        // Logic check selected (ƒê∆°n gi·∫£n h√≥a)
                        let selected = '';
                        if (exe.status === 'Online' && o.val === 'Online') selected = 'selected';
                        else if (exe.status === 'Offline' && o.val === 'Offline') selected = 'selected';
                        // Partial logic check text inside link (Optional enhancement)
                        statusOptions += `<option value="${o.val}" ${selected}>${o.label}</option>`;
                    });
                } else {
                    // 2 Options cho Single Link
                    statusOptions = `
                        <option value="Online" ${exe.status === 'Online' ? 'selected' : ''}>üü¢ Online</option>
                        <option value="Offline" ${exe.status === 'Offline' ? 'selected' : ''}>üî¥ Offline</option>
                    `;
                }

                // Inputs cho Links
                let linkInputs = '';
                if (isDual) {
                    linkInputs = `
                        <div class="form-group">
                            <label>Link Global:</label>
                            <input type="text" class="form-control" value="${exe.links[0].url}" onchange="updateLink('${platform}', ${index}, 0, this.value)">
                        </div>
                        <div class="form-group">
                            <label>Link VNG:</label>
                            <input type="text" class="form-control" value="${exe.links[1].url}" onchange="updateLink('${platform}', ${index}, 1, this.value)">
                        </div>
                    `;
                } else {
                    linkInputs = `
                        <div class="form-group">
                            <label>Link T·∫£i:</label>
                            <input type="text" class="form-control" value="${exe.links[0].url}" onchange="updateLink('${platform}', ${index}, 0, this.value)">
                        </div>
                    `;
                }

                // Render Card
                const card = `
                    <div class="executor-card">
                        <div class="card-header">
                            <span>${exe.name}</span>
                            <i class="fas fa-edit"></i>
                        </div>
                        
                        <div class="form-group">
                            <label>Version:</label>
                            <input type="text" class="form-control" value="${exe.version}" onchange="updateVersion('${platform}', ${index}, this.value)">
                        </div>

                        <div class="form-group">
                            <label>Tr·∫°ng th√°i (Status):</label>
                            <select class="form-control" onchange="updateStatus('${platform}', ${index}, this.value, ${isDual})">
                                ${statusOptions}
                            </select>
                        </div>

                        ${linkInputs}
                    </div>
                `;
                container.innerHTML += card;
            });
        }

        // --- UPDATING DATA IN MEMORY ---
        function updateVersion(platform, index, newVal) {
            DATA[platform][index].version = newVal;
        }

        function updateLink(platform, exeIndex, linkIndex, newVal) {
            DATA[platform][exeIndex].links[linkIndex].url = newVal;
        }

        function updateStatus(platform, index, newVal, isDual) {
            const exe = DATA[platform][index];
            
            if (!isDual) {
                exe.status = newVal;
                exe.links[0].statusText = `Status: ${newVal}`;
            } else {
                // Logic map l·∫°i status text cho Dual
                if (newVal === 'Online') {
                    exe.status = 'Online';
                    exe.links[0].statusText = "Global: Online";
                    exe.links[1].statusText = "VNG: Online";
                } else if (newVal === 'Offline') {
                    exe.status = 'Offline';
                    exe.links[0].statusText = "Global: Offline";
                    exe.links[1].statusText = "VNG: Offline";
                } else if (newVal === 'Partial_GOn') { // Global On, VNG Off
                    exe.status = 'Partial';
                    exe.links[0].statusText = "Global: Online";
                    exe.links[1].statusText = "VNG: Offline";
                } else if (newVal === 'Partial_VOn') { // Global Off, VNG On
                    exe.status = 'Partial';
                    exe.links[0].statusText = "Global: Offline";
                    exe.links[1].statusText = "VNG: Online";
                }
            }
        }

        // --- GENERATE JS STRING (Reverse Parser) ---
        function generateJS(data) {
            // H√†m n√†y t√°i t·∫°o l·∫°i chu·ªói JS y h·ªát format c·ªßa Bot
            const formatLinks = (links) => {
                return links.map(link => {
                    let str = `{ text: "${link.text}", url: "${link.url}", className: "${link.className}"`;
                    if (link.statusText) str += `, statusText: "${link.statusText}"`;
                    str += ` }`;
                    return str;
                }).join(',\n                    ');
            };

            const platforms = Object.keys(data).map(p => {
                if (!data[p]) return '';
                const exeStrings = data[p].map(exe => `            {
                name: "${exe.name}",
                logo: "${exe.logo}",
                version: "${exe.version}",
                status: "${exe.status}",
                links: [
                    ${formatLinks(exe.links)}
                ]
            }`).join(',\n');
                return `        ${p}: [\n${exeStrings}\n        ]`;
            }).join(',\n');

            return `{\n${platforms}\n    }`;
        }

        // --- SAVE TO GITHUB ---
        async function saveToGithub() {
            const btn = document.querySelector('.fab-save');
            if(btn.classList.contains('loading')) return;

            const confirmSave = confirm("B·∫°n c√≥ ch·∫Øc mu·ªën l∆∞u c√°c thay ƒë·ªïi l√™n GitHub kh√¥ng?");
            if(!confirmSave) return;

            btn.classList.add('loading');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            // T√°i t·∫°o n·ªôi dung file JS
            // L∆∞u √Ω: C·∫ßn l·∫•y khung file g·ªëc (n·∫øu c√≥ bi·∫øn kh√°c) ho·∫∑c ghi ƒë√® to√†n b·ªô n·∫øu ch·ªâ c√≥ EXECUTOR_DATA
            // ƒê·ªÉ an to√†n v√† ƒë·ªìng b·ªô v·ªõi Bot, ta ch·ªâ n√™n thay th·∫ø object EXECUTOR_DATA
            // Nh∆∞ng ·ªü Front-end kh√≥ fetch file g·ªëc ƒë·ªÉ replace string.
            // N√™n ta s·∫Ω g·ª≠i object DATA v·ªÅ Server (api/save.js), server s·∫Ω lo vi·ªác gh√©p string.
            
            // C√°ch t·ªët nh·∫•t: G·ª≠i chu·ªói object DATA ƒë√£ format v·ªÅ
            const newDataString = generateJS(DATA);
            
            // Tuy nhi√™n api/save.js hi·ªán t·∫°i ghi ƒë√® to√†n b·ªô file content.
            // ƒê·ªÉ ƒë∆°n gi·∫£n v√† kh√¥ng c·∫ßn s·ª≠a api/save.js ph·ª©c t·∫°p, ta s·∫Ω fetch l·∫°i file g·ªëc ·ªü ƒë√¢y, replace v√† g·ª≠i full content.
            
            try {
                const resRaw = await fetch('https://raw.githubusercontent.com/ugphone839/Executors/refs/heads/main/script.js?t=' + Date.now());
                const originalText = await resRaw.text();
                
                // Replace
                const finalContent = originalText.replace(/const EXECUTOR_DATA = {[\s\S]*?};/, `const EXECUTOR_DATA = ${newDataString};`);

                // Send to API
                const res = await fetch('/api/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: finalContent, password: PASSWORD })
                });

                const json = await res.json();

                if (res.ok) {
                    alert("‚úÖ " + json.message);
                } else {
                    alert("‚ùå L·ªói: " + json.message);
                }

            } catch (e) {
                alert("‚ùå L·ªói k·∫øt n·ªëi: " + e.message);
            } finally {
                btn.classList.remove('loading');
                btn.innerHTML = '<i class="fas fa-save"></i>';
            }
        }
    </script>
</body>
</html>
