<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executor Admin Panel - Sync Pro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg: #121212; --surface: #1e1e1e; --primary: #bb86fc;
            --secondary: #03dac6; --text: #e0e0e0; --danger: #cf6679; --success: #4caf50;
        }

        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); overflow-x: hidden; }
        
        /* LOGIN SCREEN */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .login-box { background: var(--surface); padding: 30px; border-radius: 10px; text-align: center; width: 300px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .login-box h2 { margin-bottom: 20px; color: var(--primary); }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; background: #333; border: 1px solid #555; color: white; border-radius: 5px; box-sizing: border-box; }
        .btn { padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: black; width: 100%; margin-top: 10px; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; margin-top: 10px; width: 100%; }
        
        /* HEADER */
        .header {
            background: var(--surface); padding: 15px; display: flex; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5); position: sticky; top: 0; z-index: 100;
        }
        .menu-btn { font-size: 24px; cursor: pointer; margin-right: 20px; color: var(--primary); }

        /* SIDEBAR */
        .sidebar {
            position: fixed; left: -280px; top: 0; bottom: 0; width: 260px;
            background: #181818; transition: 0.3s; z-index: 1000; padding-top: 20px;
            border-right: 1px solid #333; box-shadow: 5px 0 15px rgba(0,0,0,0.5);
        }
        .sidebar.active { left: 0; }
        .nav-group { padding: 20px 20px 10px; font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 2px; }
        .nav-item {
            padding: 15px 20px; cursor: pointer; display: flex; align-items: center; transition: 0.2s; color: #ccc;
        }
        .nav-item:hover, .nav-item.active { background: #2a2a2a; color: var(--primary); }
        .nav-item i { margin-right: 15px; width: 20px; text-align: center; font-size: 18px; }

        /* OVERLAY FOR SIDEBAR */
        #sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 999; display: none;
        }
        #sidebar-overlay.active { display: block; }

        /* CONTENT */
        .main-content { padding: 20px; max-width: 800px; margin: 0 auto; transition: 0.3s; padding-bottom: 120px; }

        /* CARDS */
        .card { background: var(--surface); border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #333; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .card-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: var(--secondary); display: flex; justify-content: space-between; align-items: center; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 13px; color: #aaa; font-weight: 600; }
        .form-control {
            width: 100%; padding: 12px; background: #2c2c2c; border: 1px solid #444;
            color: white; border-radius: 6px; box-sizing: border-box; font-size: 14px;
        }
        .form-control:focus { outline: none; border-color: var(--primary); background: #333; }

        /* DELETE ITEM */
        .delete-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; border-bottom: 1px solid #333; background: #252525; border-radius: 8px; margin-bottom: 10px;
        }

        /* FAB SAVE */
        .fab-save {
            position: fixed; bottom: 30px; right: 30px;
            background: var(--success); color: white; width: 65px; height: 65px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 28px; box-shadow: 0 6px 15px rgba(0,0,0,0.6);
            cursor: pointer; z-index: 200; transition: 0.3s;
        }
        .fab-save:hover { transform: scale(1.1) rotate(5deg); background: #66bb6a; }
        .loading-spin { animation: spin 1s infinite linear; }
        @keyframes spin { from {transform:rotate(0deg)} to {transform:rotate(360deg)} }

        .tag { font-size: 10px; padding: 3px 8px; border-radius: 12px; background: #444; color: #fff; margin-left: 10px; text-transform: uppercase; }

        #app { display: none; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <i class="fas fa-user-shield" style="font-size: 50px; color: var(--primary); margin-bottom: 15px;"></i>
            <h2>Admin Login</h2>
            <input type="password" id="password-input" placeholder="M·∫≠t kh·∫©u h·ªá th·ªëng...">
            <button class="btn btn-primary" onclick="attemptLogin()">ƒêƒÇNG NH·∫¨P</button>
        </div>
    </div>

    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div id="app">
        <div class="header">
            <i class="fas fa-bars menu-btn" onclick="toggleSidebar()"></i>
            <div class="title" id="page-title">Qu·∫£n l√Ω: PC</div>
        </div>

        <div class="sidebar" id="sidebar">
            <div style="text-align: center; padding: 20px 0; border-bottom: 1px solid #333;">
                <i class="fas fa-tools" style="font-size: 40px; color: var(--primary);"></i>
                <div style="margin-top: 10px; font-weight: bold;">H·ªÜ TH·ªêNG QU·∫¢N TR·ªä</div>
            </div>
            <div class="nav-group">Ch·ªânh s·ª≠a n·ªôi dung</div>
            <div class="nav-item active" onclick="switchView('edit', 'pc')"><i class="fas fa-desktop"></i> PC Devices</div>
            <div class="nav-item" onclick="switchView('edit', 'android')"><i class="fab fa-android"></i> Android Devices</div>
            <div class="nav-item" onclick="switchView('edit', 'ios')"><i class="fab fa-apple"></i> iOS Devices</div>
            
            <div class="nav-group">H√†nh ƒë·ªông nhanh</div>
            <div class="nav-item" onclick="switchView('add')"><i class="fas fa-plus-circle"></i> Th√™m Executor m·ªõi</div>
            <div class="nav-item" onclick="switchView('delete')"><i class="fas fa-trash-alt"></i> X√≥a Executor</div>
        </div>

        <div class="main-content" id="content-area"></div>

        <div class="fab-save" id="save-btn" onclick="saveToGithub()" title="L∆∞u t·∫•t c·∫£ thay ƒë·ªïi">
            <i class="fas fa-check"></i>
        </div>
    </div>

    <script>
        let DATA = null;
        let PASSWORD = "";
        let CURRENT_PLATFORM = 'pc';
        let CURRENT_VIEW = 'edit'; 

        function attemptLogin() {
            PASSWORD = document.getElementById('password-input').value;
            if(!PASSWORD) return;
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            loadData();
        }

        async function loadData() {
            const area = document.getElementById('content-area');
            area.innerHTML = "<div style='text-align:center; margin-top:50px;'><i class='fas fa-circle-notch fa-spin' style='font-size:40px; color:var(--primary)'></i><p>ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu...</p></div>";
            
            try {
                // LOAD TR·ª∞C TI·∫æP T·ª™ FILE T·∫†I CH·ªñ (script.js trong c√πng folder)
                // Th√™m timestamp ƒë·ªÉ x√≥a cache tr√¨nh duy·ªát
                const res = await fetch('./script.js?t=' + Date.now());
                if (!res.ok) throw new Error("Kh√¥ng t√¨m th·∫•y file script.js t·∫°i th∆∞ m·ª•c n√†y.");
                const text = await res.text();
                
                const match = text.match(/const EXECUTOR_DATA = ({[\s\S]*?});/);
                if (match) {
                    DATA = eval('(' + match[1] + ')');
                    render();
                } else {
                    throw new Error("C·∫•u tr√∫c file script.js kh√¥ng h·ª£p l·ªá (Thi·∫øu bi·∫øn EXECUTOR_DATA).");
                }
            } catch (e) { 
                area.innerHTML = `<div class="card" style="border-color:var(--danger)"><h3>‚ùå L·ªói Load D·ªØ Li·ªáu</h3><p>${e.message}</p><button class="btn btn-primary" onclick="loadData()">Th·ª≠ l·∫°i</button></div>`;
            }
        }

        function toggleSidebar() { 
            document.getElementById('sidebar').classList.toggle('active'); 
            document.getElementById('sidebar-overlay').classList.toggle('active');
        }

        function switchView(view, platform = null) {
            CURRENT_VIEW = view;
            if(platform) CURRENT_PLATFORM = platform;
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // Highlight item logic
            if(platform) {
                document.querySelectorAll('.nav-item').forEach(el => {
                    if(el.innerText.toLowerCase().includes(platform)) el.classList.add('active');
                });
            } else if(view === 'add') {
                document.querySelectorAll('.nav-item')[3].classList.add('active');
            } else if(view === 'delete') {
                document.querySelectorAll('.nav-item')[4].classList.add('active');
            }

            if(document.getElementById('sidebar').classList.contains('active')) toggleSidebar();
            render();
        }

        function render() {
            const area = document.getElementById('content-area');
            const title = document.getElementById('page-title');
            area.innerHTML = "";

            if (CURRENT_VIEW === 'edit') {
                title.innerText = "Ch·ªânh s·ª≠a: " + CURRENT_PLATFORM.toUpperCase();
                renderEditView(area);
            } else if (CURRENT_VIEW === 'add') {
                title.innerText = "Th√™m Executor m·ªõi";
                renderAddView(area);
            } else if (CURRENT_VIEW === 'delete') {
                title.innerText = "X√≥a Executor";
                renderDeleteView(area);
            }
        }

        function renderEditView(container) {
            DATA[CURRENT_PLATFORM].forEach((exe, idx) => {
                const isDual = exe.links.length > 1;
                const card = document.createElement('div');
                card.className = 'card';
                
                // Logic th√¥ng minh ƒë·ªÉ ch·ªçn option status ban ƒë·∫ßu
                let currentStatusVal = exe.status;
                if (isDual && exe.status === 'Partial') {
                    const gText = exe.links[0].statusText.toLowerCase();
                    if (gText.includes('online')) currentStatusVal = 'Partial_GOn';
                    else currentStatusVal = 'Partial_VOn';
                }

                card.innerHTML = `
                    <div class="card-title">${exe.name} <span class="tag">${isDual?'Dual Links':'Single Link'}</span></div>
                    <div class="form-group">
                        <label><i class="fas fa-code-branch"></i> Phi√™n b·∫£n (Version):</label>
                        <input type="text" class="form-control" value="${exe.version}" oninput="DATA['${CURRENT_PLATFORM}'][${idx}].version = this.value">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-signal"></i> Tr·∫°ng th√°i ho·∫°t ƒë·ªông:</label>
                        <select class="form-control" onchange="updateStatusLogic('${CURRENT_PLATFORM}', ${idx}, this.value, ${isDual})">
                            ${renderStatusOptions(currentStatusVal, isDual)}
                        </select>
                    </div>
                    ${isDual ? `
                        <div class="form-group"><label><i class="fas fa-globe"></i> Link Global:</label><input type="text" class="form-control" value="${exe.links[0].url}" oninput="DATA['${CURRENT_PLATFORM}'][${idx}].links[0].url = this.value"></div>
                        <div class="form-group"><label><i class="fas fa-flag"></i> Link VNG:</label><input type="text" class="form-control" value="${exe.links[1].url}" oninput="DATA['${CURRENT_PLATFORM}'][${idx}].links[1].url = this.value"></div>
                    ` : `
                        <div class="form-group"><label><i class="fas fa-download"></i> Link T·∫£i tr·ª±c ti·∫øp:</label><input type="text" class="form-control" value="${exe.links[0].url}" oninput="DATA['${CURRENT_PLATFORM}'][${idx}].links[0].url = this.value"></div>
                    `}
                `;
                container.appendChild(card);
            });
        }

        function renderStatusOptions(current, isDual) {
            if(!isDual) {
                return `<option value="Online" ${current=='Online'?'selected':''}>üü¢ Ho·∫°t ƒë·ªông (Online)</option>
                        <option value="Offline" ${current=='Offline'?'selected':''}>üî¥ B·∫£o tr√¨ (Offline)</option>`;
            }
            return `<option value="Online" ${current=='Online'?'selected':''}>üü¢ C·∫£ 2 ho·∫°t ƒë·ªông</option>
                    <option value="Offline" ${current=='Offline'?'selected':''}>üî¥ C·∫£ 2 b·∫£o tr√¨</option>
                    <option value="Partial_GOn" ${current=='Partial_GOn'?'selected':''}>üü° Global On / VNG Off</option>
                    <option value="Partial_VOn" ${current=='Partial_VOn'?'selected':''}>üü° Global Off / VNG On</option>`;
        }

        function updateStatusLogic(p, idx, val, isDual) {
            const exe = DATA[p][idx];
            if(!isDual) {
                exe.status = val;
                exe.links[0].statusText = "Status: " + val;
            } else {
                if(val === 'Online') { exe.status = 'Online'; exe.links[0].statusText = "Global: Online"; exe.links[1].statusText = "VNG: Online"; }
                else if(val === 'Offline') { exe.status = 'Offline'; exe.links[0].statusText = "Global: Offline"; exe.links[1].statusText = "VNG: Offline"; }
                else if(val === 'Partial_GOn') { exe.status = 'Partial'; exe.links[0].statusText = "Global: Online"; exe.links[1].statusText = "VNG: Offline"; }
                else if(val === 'Partial_VOn') { exe.status = 'Partial'; exe.links[0].statusText = "Global: Offline"; exe.links[1].statusText = "VNG: Online"; }
            }
        }

        function renderAddView(container) {
            container.innerHTML = `
                <div class="card">
                    <div class="form-group"><label>T√™n ·ª©ng d·ª•ng:</label><input type="text" id="add-name" class="form-control" placeholder="V√≠ d·ª•: Arceus X"></div>
                    <div class="form-group"><label>Link Global (B·∫Øt bu·ªôc):</label><input type="text" id="add-lg" class="form-control" placeholder="https://..."></div>
                    <div class="form-group"><label>Link VNG (N·∫øu kh√¥ng c√≥ h√£y b·ªè tr·ªëng):</label><input type="text" id="add-lv" class="form-control" placeholder="https://..."></div>
                    <div class="form-group"><label>Phi√™n b·∫£n (Version):</label><input type="text" id="add-ver" class="form-control" placeholder="V√≠ d·ª•: 2.1.4"></div>
                    <div class="form-group"><label>Link ·∫£nh Logo:</label><input type="text" id="add-logo" class="form-control" placeholder="https://..."></div>
                    <div class="form-group">
                        <label>D√†nh cho thi·∫øt b·ªã:</label>
                        <select id="add-platform" class="form-control">
                            <option value="pc">M√°y t√≠nh (PC)</option>
                            <option value="android">ƒêi·ªán tho·∫°i (Android)</option>
                            <option value="ios">ƒêi·ªán tho·∫°i (iOS)</option>
                        </select>
                    </div>
                    <button class="btn btn-success" onclick="executeAdd()"><i class="fas fa-plus"></i> X√ÅC NH·∫¨N TH√äM</button>
                </div>
            `;
        }

        function executeAdd() {
            const name = document.getElementById('add-name').value;
            const lg = document.getElementById('add-lg').value;
            const lv = document.getElementById('add-lv').value;
            const ver = document.getElementById('add-ver').value;
            const logo = document.getElementById('add-logo').value;
            const plat = document.getElementById('add-platform').value;

            if(!name || !lg || !ver || !logo) return alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!");

            let links = [];
            if(lv.trim() !== "") {
                links.push({ text: "Global", url: lg, className: "btn-download-main", statusText: "Global: Online" });
                links.push({ text: "VNG", url: lv, className: "btn-download-alt", statusText: "VNG: Online" });
            } else {
                links.push({ text: "Download", url: lg, className: "btn-download-main", statusText: "Status: Online" });
            }

            const newExe = { name, logo, version: ver, status: "Online", links };
            DATA[plat].push(newExe);
            alert(`ƒê√£ th√™m ${name} v√†o danh s√°ch ch·ªù c·ªßa ${plat.toUpperCase()}!`);
            switchView('edit', plat);
        }

        function renderDeleteView(container) {
            ['pc', 'android', 'ios'].forEach(plat => {
                if(DATA[plat].length === 0) return;
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `<div class="card-title" style="color:var(--primary)">H·ªá ƒëi·ªÅu h√†nh: ${plat.toUpperCase()}</div>`;
                DATA[plat].forEach((exe, idx) => {
                    const item = document.createElement('div');
                    item.className = 'delete-item';
                    item.innerHTML = `<div><b style="color:white">${exe.name}</b> <br><small style="color:#777">v${exe.version}</small></div>
                                      <button class="btn btn-danger" style="padding: 8px 15px" onclick="executeDelete('${plat}', ${idx})"><i class="fas fa-trash"></i> X√≥a</button>`;
                    card.appendChild(item);
                });
                container.appendChild(card);
            });
        }

        function executeDelete(plat, idx) {
            if(confirm(`B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a "${DATA[plat][idx].name}" kh·ªèi h·ªá th·ªëng?`)) {
                DATA[plat].splice(idx, 1);
                render();
            }
        }

        function generateJSString(data) {
            const formatLinks = links => links.map(l => 
                `{ text: "${l.text}", url: "${l.url}", className: "${l.className}"${l.statusText ? `, statusText: "${l.statusText}"` : ''} }`
            ).join(',\n                    ');
            
            const platforms = Object.keys(data).map(p => {
                const exes = data[p].map(e => 
                    `            {
                name: "${e.name}",
                logo: "${e.logo}",
                version: "${e.version}",
                status: "${e.status}",
                links: [
                    ${formatLinks(e.links)}
                ]
            }`
                ).join(',\n');
                return `        ${p}: [\n${exes}\n        ]`;
            }).join(',\n');
            return `const EXECUTOR_DATA = {\n${platforms}\n    };`;
        }

        async function saveToGithub() {
            if(!confirm("X√°c nh·∫≠n l∆∞u m·ªçi thay ƒë·ªïi l√™n GitHub v√† c·∫≠p nh·∫≠t trang web?")) return;

            const btn = document.getElementById('save-btn');
            btn.innerHTML = '<i class="fas fa-spinner loading-spin"></i>';
            btn.style.pointerEvents = 'none';

            const newDataString = generateJSString(DATA);
            
            try {
                // T·∫£i file g·ªëc t·ª´ GitHub ƒë·ªÉ gi·ªØ nguy√™n c·∫•u tr√∫c bao quanh
                const resRaw = await fetch('https://raw.githubusercontent.com/ugphone839/Executors/refs/heads/main/script.js?t=' + Date.now());
                const originalText = await resRaw.text();
                
                // Thay th·∫ø ph·∫ßn data m·ªõi
                const finalContent = originalText.replace(/const EXECUTOR_DATA = {[\s\S]*?};/, newDataString);

                const res = await fetch('/api/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: finalContent, password: PASSWORD })
                });

                const result = await res.json();
                if (res.ok) {
                    alert("‚úÖ L∆ØU TH√ÄNH C√îNG!\nWeb s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t sau √≠t ph√∫t.");
                    location.reload();
                } else {
                    throw new Error(result.message);
                }
            } catch (e) { 
                alert("‚ùå L·ªñI L∆ØU D·ªÆ LI·ªÜU: " + e.message); 
            } finally { 
                btn.innerHTML = '<i class="fas fa-check"></i>'; 
                btn.style.pointerEvents = 'auto';
            }
        }
    </script>
</body>
</html>
